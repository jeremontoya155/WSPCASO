<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seleccionar Acciones</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    
</head>
<body>


    <div class="container">
        <h1>Selecciona las Acciones</h1>

        <div id="metrics-container">
            <h2>Métricas del Bot</h2>
            <p>Total de acciones realizadas: <span id="total-acciones">0</span></p>
            <ul>
                <li>Seguir Usuarios: <span id="seguir-usuarios">0</span></li>
                <li>Dar Me Gusta: <span id="dar-me-gusta">0</span></li>
                <li>Comentar: <span id="comentar-publicacion">0</span></li>
                <li>Enviar DM: <span id="enviar-dm">0</span></li>
                <li>Ver Historias: <span id="ver-historias">0</span></li>
            </ul>
        </div>

        <!-- Nueva sección: Tiempo de actividad -->
        <div id="time-container">
            <h2>Tiempo de Actividad del Bot</h2>
            <p>Tiempo en ejecución: <span id="tiempo-actividad">00:00:00</span></p>
        </div>
        
        <h2>Configurar Comportamiento de la IA</h2>
        <label for="rol-ia">Selecciona el Rol de la IA:</label>
        <select id="rol-ia" name="rol">
            <option value="amigable">Amigable</option>
            <option value="experto_negocios">Experto en Negocios</option>
            <option value="técnico">Técnico</option>
            <option value="motivador">Motivador</option>
        </select>

        <!-- Formulario de Competidores y Filtros -->
        <form id="filters-form" style="margin-bottom: 20px;">
            <h2>Configurar Tiempo de Trabajo</h2>
            <label for="duracion">Duración del trabajo del bot (en horas):</label>
            <select id="duracion" name="duracion">
                <option value="1">1 hora</option>
                <option value="2">2 horas</option>
                <option value="3">3 horas</option>
                <option value="4">4 horas</option>
                <option value="5">5 horas</option>
                <option value="6">6 horas</option>
            </select>
            <small>El tiempo por defecto es 6 horas.</small>
            <h2>Usuarios de Competencia</h2>
            <label for="competidores">Competidores:</label>
            <textarea id="competidores" name="competidores" rows="3" placeholder="Ingresa competidores separados por comas">{{ competencia }}</textarea>
            <small>Ejemplo: competencia1, competencia2, competencia3</small>
    
            <h2>Configurar Filtros</h2>
            <label for="ubicaciones">Ubicaciones:</label>
            <input type="text" id="ubicaciones" name="ubicaciones" placeholder="Ej: chile, santiago">
    
            <label for="palabras_clave">Palabras clave en la biografía:</label>
            <input type="text" id="palabras_clave" name="palabras_clave" placeholder="Ej: emprendedor, marketing">
    
            <label for="min_publicaciones">Mínimo de Publicaciones:</label>
            <input type="number" id="min_publicaciones" name="min_publicaciones" value="10">
    
            <label for="min_seguidores">Mínimo de Seguidores:</label>
            <input type="number" id="min_seguidores" name="min_seguidores" value="100">
    
            <label for="tipo_cuenta">Tipo de Cuenta:</label>
            <select id="tipo_cuenta" name="tipo_cuenta">
                <option value="publica">Pública</option>
                <option value="privada">Privada</option>
            </select>
    
            <button type="submit">Aplicar Filtros</button>
        </form>
    

            <!-- Contenedor para mostrar usuarios -->
            <div id="users-container">
                <p>No hay usuarios procesados todavía.</p>
            </div>
        </div>
        <button id="cargar-mas">Cargar más usuarios procesados</button>
    
    </div>
    
    <script>
        let processedUserIds = new Set();
        console.log("[DEBUG] Inicializando el frontend..."); // IDs procesados para evitar duplicados
        const cantidadPorCarga = 3; // Cantidad de usuarios por lote
    
        // Crear tarjeta de usuario
        function crearUserCard(user) {
            console.log(`[DEBUG] Creando tarjeta para usuario: ${user.username || "Sin username"}`); // Verificar datos del usuario
            return `
                <div class="user-card" data-user-id="${user.id || "Sin ID"}">
                    <h2>Usuario: ${user.username || "Sin nombre de usuario"}</h2>
                    <p>Biografía: ${user.biography || "Sin biografía disponible"}</p>
                    <p>Seguidores: ${user.follower_count || "No disponible"}</p>
                    <p>Publicaciones: ${user.media_count || "No disponible"}</p>
                    <p>Acciones realizadas: ${accionesRealizadas}</p>
                </div>
            `;
        }
       
        async function cargarLoteUsuariosProcesados() {
    try {
        console.log("[DEBUG] Solicitando lote de usuarios procesados...");
        const response = await fetch('/procesar_usuarios', { method: 'POST' });

        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }

        const data = await response.json();

        if (data.success) {
            console.log(`[DEBUG] Usuarios procesados recibidos: ${data.processed_users.length}`);
            const usersContainer = document.getElementById('users-container');

            // Añadir las tarjetas de los usuarios procesados al contenedor
            data.processed_users.forEach(user => {
                if (!processedUserIds.has(user.id)) {
                    const userCard = crearUserCard(user);
                    usersContainer.innerHTML += userCard;
                    processedUserIds.add(user.id); // Evitar duplicados
                }
            });

            // Verificar si el lote está completo
            verificarLoteCompleto();
        } else {
            console.error("[DEBUG] Error al procesar usuarios:", data.error);
            mostrarMensajeError(data.error || "Error desconocido al procesar usuarios.");
        }
    } catch (error) {
        console.error("[DEBUG] Error al cargar usuarios procesados:", error);
        mostrarMensajeError("Hubo un problema al cargar usuarios procesados.");
    }
}

 // Actualización del tiempo de actividad
 let tiempoInicio = Date.now();

function actualizarTiempoActividad() {
    const ahora = Date.now();
    const tiempoTranscurrido = ahora - tiempoInicio;
    const horas = String(Math.floor(tiempoTranscurrido / 3600000)).padStart(2, '0');
    const minutos = String(Math.floor((tiempoTranscurrido % 3600000) / 60000)).padStart(2, '0');
    const segundos = String(Math.floor((tiempoTranscurrido % 60000) / 1000)).padStart(2, '0');
    document.getElementById('tiempo-actividad').textContent = `${horas}:${minutos}:${segundos}`;
}

// Botón para cargar más usuarios procesados
document.getElementById('cargar-mas').addEventListener('click', () => {
    cargarLoteUsuariosProcesados();
});

        // Obtener y mostrar métricas
        async function actualizarMetricas() {
            try {
                const response = await fetch('/metrics');
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
    
                const metrics = await response.json();
    
                // Actualizar los valores en el contenedor de métricas
                document.getElementById('total-acciones').textContent = metrics.acciones_realizadas || 0;
                document.getElementById('seguir-usuarios').textContent = metrics.desglose_acciones.seguir_usuario || 0;
                document.getElementById('dar-me-gusta').textContent = metrics.desglose_acciones.dar_me_gusta_a_publicaciones || 0;
                document.getElementById('comentar-publicacion').textContent = metrics.desglose_acciones.comentar_publicacion || 0;
                document.getElementById('enviar-dm').textContent = metrics.desglose_acciones.enviar_dm || 0;
                document.getElementById('ver-historias').textContent = metrics.desglose_acciones.ver_historias || 0;
            } catch (error) {
                console.error('Error al actualizar las métricas:', error);
            }
        }
    
        // Llamar a la función al cargar la página
        actualizarMetricas();
        setInterval(actualizarMetricas, 10000); // Actualizar automáticamente cada 10 segundos
    
        // Enviar filtros desde el formulario
        document.getElementById('filters-form').addEventListener('submit', async (event) => {
    event.preventDefault();

    const competencia = document.getElementById('competidores').value.trim();
    const duracion = document.getElementById('duracion').value; // Nuevo campo
    const formData = new FormData(event.target);

    formData.append('duracion', duracion); // Agregamos la duración al formulario

    try {
        mostrarCargando(true);
        const response = await fetch('/aplicar_filtros', { method: 'POST', body: formData });

        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }

        const data = await response.json();
        mostrarCargando(false);

        if (data.success) {
            console.log(`[DEBUG] Usuarios procesados recibidos: ${data.users.length}`);
            // Aquí procesamos los datos como siempre
        } else {
            mostrarMensajeError(`Error al aplicar filtros: ${data.error}`);
        }
    } catch (error) {
        mostrarCargando(false);
        console.error('[DEBUG] Error al aplicar filtros:', error);
        mostrarMensajeError('Hubo un problema al aplicar los filtros.');
    }
});


function mostrarMensajeError(mensaje) {
    const mensajeError = document.getElementById('mensaje-error');
    if (!mensajeError) {
        const contenedor = document.createElement('div');
        contenedor.id = 'mensaje-error';
        contenedor.style.position = 'fixed';
        contenedor.style.top = '10px';
        contenedor.style.left = '50%';
        contenedor.style.transform = 'translateX(-50%)';
        contenedor.style.backgroundColor = '#f8d7da';
        contenedor.style.color = '#721c24';
        contenedor.style.padding = '10px 20px';
        contenedor.style.border = '1px solid #f5c6cb';
        contenedor.style.borderRadius = '5px';
        contenedor.style.zIndex = '1000';
        contenedor.textContent = mensaje;
        document.body.appendChild(contenedor);

        setTimeout(() => contenedor.remove(), 5000);
    } else {
        mensajeError.textContent = mensaje;
    }
}
function mostrarCargando(estado) {
    const spinner = document.getElementById('spinner');
    if (!spinner) {
        const nuevoSpinner = document.createElement('div');
        nuevoSpinner.id = 'spinner';
        nuevoSpinner.style.position = 'fixed';
        nuevoSpinner.style.top = '50%';
        nuevoSpinner.style.left = '50%';
        nuevoSpinner.style.transform = 'translate(-50%, -50%)';
        nuevoSpinner.style.border = '4px solid #f3f3f3';
        nuevoSpinner.style.borderTop = '4px solid #3498db';
        nuevoSpinner.style.borderRadius = '50%';
        nuevoSpinner.style.width = '40px';
        nuevoSpinner.style.height = '40px';
        nuevoSpinner.style.animation = 'spin 1s linear infinite';
        document.body.appendChild(nuevoSpinner);

        // Añadir estilos para animación (si no están ya en CSS)
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }

    document.getElementById('spinner').style.display = estado ? 'block' : 'none';
}


    </script>
    

    
</body>
</html>
