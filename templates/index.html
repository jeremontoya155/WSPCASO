<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio de Sesión - Instagram Bot</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1>Inicia Sesión</h1>

        <!-- Formulario de inicio de sesión -->
        <form id="instagram-login-form" method="POST" action="/instagram-login">
            <label for="instagram-username">Usuario de Instagram:</label>
            <input type="text" id="instagram-username" name="instagram_username" required>
        
            <label for="instagram-password">Contraseña de Instagram:</label>
            <input type="password" id="instagram-password" name="instagram_password" required>
        
            <button type="submit">Iniciar sesión en Instagram</button>
        </form>
        

        <div id="form-2fa" style="display: none;">
            <h2>Autenticación 2FA</h2>
            <form id="two-fa-form">
                <label for="2fa-code">Ingrese el Código de 2FA:</label>
                <input type="text" id="2fa-code" name="code" required>
                <button type="submit">Enviar Código</button>
                <p id="error-2fa" style="color: red; margin-top: 10px;"></p>
            </form>
        </div>

        <div id="form-challenge" style="display: none;">
            <h2>Verificación de Seguridad</h2>
            <form id="challenge-form">
                <label for="challenge-code">Ingrese el Código de Verificación:</label>
                <input type="text" id="challenge-code" name="code" required>
                <button type="submit">Enviar Código</button>
                <p id="error-challenge" style="color: red; margin-top: 10px;"></p>
            </form>
        </div>

        <!-- Formulario para cerrar sesión -->
        <form action="/logout" method="POST" style="margin-top: 20px; text-align: center;">
            <button id="boton-cerrar-sesion" class="logout-btn" style="background-color: #f44336; color: white; padding: 5px 10px; font-size: 12px; border: none; border-radius: 5px; cursor: pointer; width: 100px;">
                Cerrar sesión
            </button>
        </form>

        <!-- Mensajes del backend -->
        {% if error %}
        <p style="color: red; margin-top: 20px;">{{ error }}</p>
        {% endif %}
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const loginForm = document.getElementById('instagram-login-form');
            const twoFaForm = document.getElementById('form-2fa');
            const challengeForm = document.getElementById('form-challenge');
        
            const twoFaCodeInput = document.getElementById('2fa-code');
            const challengeCodeInput = document.getElementById('challenge-code');
        
            const errorTwoFaMessage = document.getElementById("error-2fa");
            const errorChallengeMessage = document.getElementById("error-challenge");
        
            /**
             * Muestra el formulario correspondiente y oculta los demás.
             * @param {string} tipo - Tipo de formulario a mostrar ("challenge", "2fa", "login").
             */
            function mostrarFormulario(tipo) {
                loginForm.style.display = "none";
                twoFaForm.style.display = "none";
                challengeForm.style.display = "none";
        
                if (tipo === "challenge") {
                    challengeForm.style.display = "block";
                    console.log("[DEBUG] Mostrando formulario de Challenge");
                } else if (tipo === "2fa") {
                    twoFaForm.style.display = "block";
                    console.log("[DEBUG] Mostrando formulario de 2FA");
                } else {
                    loginForm.style.display = "block";
                    console.log("[DEBUG] Mostrando formulario de Login");
                }
            }
        
            /**
             * Maneja la respuesta del backend para determinar qué formulario mostrar.
             * @param {object} data - Respuesta del backend.
             */
            function manejarRespuestaLogin(data) {
                console.log("[DEBUG] Respuesta del backend:", data);
        
                if (data.challenge_required) {
                    alert(data.message);
                    mostrarFormulario("challenge");
                } else if (data["2fa_required"]) {
                    alert(data.message);
                    mostrarFormulario("2fa");
                } else if (data.success) {
                    alert(data.message);
                    window.location.href = data.redirect || "/acciones";
                } else {
                    alert(`Error: ${data.error || "Error desconocido."}`);
                }
            }
        
            /**
             * Envía una solicitud de inicio de sesión a Instagram.
             */
            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const username = document.getElementById('instagram-username').value.trim();
                const password = document.getElementById('instagram-password').value.trim();
        
                if (!username || !password) {
                    alert("Debes ingresar un usuario y contraseña de Instagram.");
                    return;
                }
        
                try {
                    const response = await fetch('/instagram-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ instagram_username: username, instagram_password: password }),
                    });
        
                    const data = await response.json();
                    manejarRespuestaLogin(data);
                } catch (error) {
                    console.error("[DEBUG] Error en la solicitud de inicio de sesión:", error);
                    alert("Hubo un problema al iniciar sesión.");
                }
            });
        
            /**
             * Maneja el envío del código de verificación del challenge.
             */
            challengeForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const code = challengeCodeInput.value.trim();
        
                if (!code) {
                    errorChallengeMessage.innerText = "Debes ingresar un código de verificación.";
                    return;
                }
        
                try {
                    const response = await fetch('/verify-challenge', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code }),
                    });
        
                    const data = await response.json();
                    console.log("[DEBUG] Respuesta del backend (Challenge):", data);
        
                    if (data.success) {
                        alert("Verificación completada.");
                        window.location.href = data.redirect || "/acciones"; // Usa la ruta que envía el backend
                    } else {
                        errorChallengeMessage.innerText = `Error: ${data.error || "Error desconocido."}`;
                    }
                } catch (error) {
                    console.error("[DEBUG] Error en la verificación de Challenge:", error);
                    errorChallengeMessage.innerText = "Hubo un problema con la verificación.";
                }
            });
        
            /**
             * Maneja el envío del código de autenticación 2FA.
             */
            twoFaForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const code = twoFaCodeInput.value.trim();
        
                if (!code) {
                    errorTwoFaMessage.innerText = "Debes ingresar un código de 2FA.";
                    return;
                }
        
                try {
                    const response = await fetch('/verify-2fa', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ code }),
                    });
        
                    const data = await response.json();
                    console.log("[DEBUG] Respuesta del backend (2FA):", data);
        
                    if (data.challenge_required) {
                        alert(data.message);
                        mostrarFormulario("challenge");
                    } else if (data.success) {
                        alert("Autenticación 2FA exitosa.");
                        window.location.href = data.redirect || "/acciones"; // Usa la ruta que envía el backend
                    } else {
                        errorTwoFaMessage.innerText = `Error en autenticación 2FA: ${data.error || "Error desconocido."}`;
                    }
                } catch (error) {
                    console.error("[DEBUG] Error en la solicitud de 2FA:", error);
                    errorTwoFaMessage.innerText = "Hubo un problema con la autenticación 2FA.";
                }
            });
        });
        </script>
        
</body>
</html>
